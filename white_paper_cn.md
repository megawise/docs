# MegaWise

## 前言

随着数字化的不断深入，数据在我们的生活中所扮演的角色日益重要。毫不夸张地讲，我们今天所处的正是一个数据时代。也由此催生了人们对数据分析，数据智能的强烈需求。我们对世界的认识、对社会的管理，都需要通过无所不在的数据进行驱动。伴随革命性的 5G 通信技术，这个时代的数据风暴正变得越来越猛烈。

- 数据量爆发式增长，2018 ~ 2025 数据量至少增长 6 倍
- 数据连接数量指数级，跨越式增长。4G 网络连接密度约 1,000 Connection / KM<sup>2</sup> ，5G 网络连接密度约 1,000,000 Connection / KM<sup>2</sup>

然而，根据从大数据处理中得到的经验，倍增的数据，并不能带来倍增的价值。数据量越大，价值密度可能越低。另一方面，以 CPU 为代表的传统处理器的性能增长已逐渐放缓，摩尔定律几近失效。继续用传统方法与工具进行数据分析处理，不论在性能，还是成本上都将使企业无法承受。

为帮助企业用户应对数据时代新的挑战，ZILLIZ 公司设计研发了新一代 OLAP 分析引擎 MegaWise，具有完整的自主知识产权。MegaWise率先使用 GPU 的大规模并行处理能力，对 SQL 操作进行加速。与传统方案相比，MegaWise 平台具备高吞吐、高性价比、低延时三重优势，显著降低单位算力成本，对十亿级数据集的查询分析提供亚秒级响应。


## MegaWise核心数据分析引擎

### 对 SQL 的原生支持

MegaWise 支持标准 SQL 和 PostgreSQL 语法，并提供以下接口：

- 命令行界面（ CLI ）
- Java 数据库连接（ JDBC ）和开放式数据库连接（ ODBC ）

### 矢量化查询与混合执行

查询执行的高度矢量化是 MegaWise 加速数据分析的基础。矢量化代码允许处理器同时计算众多数据项。当前的 GPU 单卡内通常包含数以千计乃至数以万计的运算执行单元，这意味着 GPU 中的矢量化查询可在单周期并行处理数千个数据项，相较 CPU 方案，数据处理的并发度提升两到三个数量级。

MegaWise 的矢量化查询技术可以同时应用到 CPU 。现代 CPU 普遍提供了向量扩展指令集，内部集成了可并行处理多个数据项的宽字执行单元。MegaWise 的 SQL Engine 可同时驱动多个 GPU 和 CPU 进行矢量化查询，即便在 CPU 中，在应用矢量化查询后，相较传统多线程方案也有显著的性能提升。

### 多级数据缓存

MegaWise 对内存和计算层进行了深度优化，以提供极致性能。MegaWise 在每个物理单节点内构建了 GPU 显存、主存、 SSD 三级缓存。根据数据热度及运算局部性，完成对数据的智能放置。需要被 GPU 频繁、连续处理的热数据，将被保存在 GPU 显存中，避免通过 PCIe 总线移动数据，以实现最快的访问速度。MegaWise 还可以利用 NVIDIA NVLink 技术加速 CPU 到 GPU 的数据传输，速度比没有 NVLink 的系统快 2.5 倍，该特性在可在 IBM OpenPOWER 服务器上使用。

MegaWise 的缓存系统同时提供与外部系统进行数据交互的能力。数据格式全面兼容 Apache Arrow 标准，在 GPU 显存、主存两个内存层均可实现对外数据交换，并支持零拷贝数据传输模式。

### 动态查询编译

MegaWise对上层应用支持常见的SQL分析操作，如过滤、聚合、连接，并提供领域加速算子，如地理信息分析、向量分析、时序分析等。为了有效屏蔽算法实现的复杂性、计算设备的异构性，并充分挖掘硬件加速器的运算能力，ZILLIZ 在 MegaWise 平台中构建了基于 LLVM 的 JIT 编译系统。LLVM 允许 MegaWise 将查询语句转换为独立于体系结构的中间代码，该中间代码可根据具体的执行硬件环境进一步生成目标代码，并面向硬件进行特定优化。这保证 MegaWise 具有良好的跨平台跨设备能力，当前 MegaWise 可在 NVIDIA GPU ，x64 CPU ，POWER CPU 和 ARM CPU 上高效运行。

MegaWise 的 JIT 系统同时提供了更快的编译速度，单条查询语句的编译时间在 **20 毫秒以下**。结合 MegaWise 的查询计划缓存系统，查询语句的平均编译时间通常在 **10 毫秒以内**。在 JIT 系统的有力支撑下，用户可以基于 SQL 进行便捷的自定义数据分析，并充分利用 CPU/GPU 所构成的混合异构运算能力，而不必关心底层硬件与算法实现的差异性。

### 终结复杂索引、降采样、预聚合

传统的数据仓库通常采用索引、降采样、预聚合等技术，以支撑大规模数据分析的性能。这些加速技术需要一个较长的预处理过程，因而难以满足现代应用中对海量数据、快数据的实时处理需求。相比之下，MegaWise 无需事先构建索引、降采样或预聚合，借助 GPU 等硬件加速器的性能红利提供即时查询能力，即使面向十亿级数据记录也可以达到几十到几百毫秒的响应速度。

避免构建复杂索引、降采样和预聚合主要带来两点优势。首先，部署 MegaWise 的用户不需要花费大量时间和资源来建模数据，只需完成数据导入即可享受到实时 SQL 查询。其次，只保留对数据的轻量预处理意味着 MegaWise 可以更快速的加载数据，这对于流数据处理场景及高频数据处理场景尤为重要。

### 性能/性价比分析

以下测试中用到的数据与查询语句来自纽约出租车历史订单（共 11 亿笔订单）。

#### 单节点 MegaWise 对比其他集群产品

- 测试环境

|              | 物理节点数 | CPU 核心数 | GPU 个数 | 内存总容量（GB） | SSD 磁盘容量（TB） |
| :------------: | ----------: | --------: | --------:| ---------------- | ------------------: |
| MegaWise     | 1          | 48       | 4        | 512              | 1.0                |
| Redshift     | 6          | 192      | 0        | 1464             | 15.4               |
| Spark 2.4    | 21         | 84       | 0        | 315              | 1.7                |
| Presto 0.214 | 21         | 84       | 0        | 315              | 1.7                |

> 友商数据引用自：https://tech.marksblogg.com/benchmarks.html

- 性能数据

|              | Q1   | Q2   | Q3   | Q4    |
| :------------: | ----: | ----: | ----: | -----: |
| MegaWise     | 0.01 | 0.12 | 0.13 | 0.24  |
| Redshift     | 1.56 | 1.25 | 2.25 | 2.97  |
| Spark 2.4    | 2.36 | 3.56 | 4.02 | 20.4  |
| Presto 0.214 | 3.54 | 6.29 | 7.66 | 11.92 |

> 友商数据引用自：https://tech.marksblogg.com/benchmarks.html

#### 单节点 MegaWise 对比其他单节点产品

- 测试环境

|              | 物理节点数 | CPU 核心数 | GPU 个数 | 内存总容量（GB） | SSD 磁盘容量（TB） |
| :------------: | ----------: | --------: | --------:| ---------------- | ------------------: |
| MegaWise      | 1          | 48       | 4        | 512              | 1.0                |
| Oracle 12.2   | 1          | 48       | 0        | 256              | 2.0                |
| PostgreSQL 10 | 1          | 128      | 0        | 1024             | 3.0                |

> 友商数据引用自：https://tech.marksblogg.com/benchmarks.html

- 性能数据

|              | Q1   | Q2   | Q3   | Q4    |
| :------------: | ----: | ----: | ----: | -----: |
| MegaWise     | 0.01 | 0.12 | 0.13 | 0.24  |
| Oracle 12.2     | 213.82 | 174.59 | 174.81 | 173.84  |
| PostgreSQL 10   | 56.55 | 56.92 | 89.90 | 94.37  |

> 友商数据引用自：https://tech.marksblogg.com/benchmarks.html


## 总结

新的数据时代，带来新的挑战。传统分析方法与框架面临性能与成本的双重困境。

MegaWise是一个融合传统 CPU 和新型异构计算芯片的 OLAP 加速引擎。通过整合异构芯片，MegaWise 能极大的提升能力。在成本可控的前提下，充分挖掘爆发式增长的数据中蕴含的新价值。
